{"data":{"logo":null,"markdownRemark":{"html":"<p>Recently I learned when Java class loader <code class=\"language-text\">load</code> a class and when does it <code class=\"language-text\">initialize</code> it.</p>\n<p>Take the following as example.</p>\n<p>We can use some special jvm options to show class loading info, like <code class=\"language-text\">java -verbose:class Singleton</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Singleton</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token function\">Singleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LazyHolder</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Singleton INSTANCE <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Singleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">static</span> <span class=\"token punctuation\">{</span>\n      System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LazyHolder.&lt;clinit>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> Object <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> flag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LazyHolder</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> LazyHolder<span class=\"token punctuation\">.</span>INSTANCE<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"----\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When execute this class, class loader will first load <code class=\"language-text\">Singleton</code>, then load <code class=\"language-text\">LazyHolder</code>. But something interesting here is jvm will not <code class=\"language-text\">clinit</code> the <code class=\"language-text\">LazyHolder</code> when constructing an empty <code class=\"language-text\">Array</code> of <code class=\"language-text\">LazyHolder</code>. It will <code class=\"language-text\">clinit</code> the class when it is being really used, like <code class=\"language-text\">return LazyHolder.INSTANCE</code>.</p>\n<p>We can try the above with script at the end.</p>\n<ol>\n<li>It will output as following order</li>\n</ol>\n<p><code class=\"language-text\">[0.123s][info][class,load] Singleton source: file:/Users/xueg/source/fun/javavm/03-how-class-load/</code>\n<code class=\"language-text\">...</code>\n<code class=\"language-text\">[0.125s][info][class,load] Singleton$LazyHolder source: file:/Users/xueg/source/fun/javavm/03-how-class-load/</code></p>\n<p>Above indicates that the order the classed loaded is <code class=\"language-text\">Singleton</code> —> <code class=\"language-text\">Singleton$LazyHolder</code></p>\n<ol start=\"2\">\n<li>and continue output following</li>\n</ol>\n<p><code class=\"language-text\">----</code></p>\n<p>This means the constructing of new LazyHolder array <code class=\"language-text\">new LazyHolder[2]</code> is called. But the <code class=\"language-text\">static{}</code> init code of the LazyHolder is still not being called.</p>\n<ol start=\"3\">\n<li>and continue output following</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java.lang.VerifyError: Operand stack overflow\nException Details:\n  Location:\n    Singleton$LazyHolder.&lt;init&gt;()V @0: aload_0\n  Reason:\n    Exceeded max stack size.\n  Current Frame:\n    bci: @0\n    flags: { flagThisUninit }\n    locals: { uninitializedThis }\n    stack: { }\n  Bytecode:\n    0000000: 2ab7 0007 b1\n\n        at Singleton.getInstance(Singleton.java:12)\n        at Singleton.main(Singleton.java:17)</code></pre></div>\n<p>This is because we mod the bytecode on purpose to show that even there’s an error in the init code, it doesn’t prevent jvm from loading the class</p>\n<p>Full scripts as follow.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Generating Singleton.java\"</span>\n<span class=\"token keyword\">echo</span> <span class=\"token string\">'\npublic class Singleton {\n  private Singleton() {}\n  private static class LazyHolder {\n    static final Singleton INSTANCE = new Singleton();\n    static {\n      System.out.println(\"LazyHolder.&lt;clinit>\");\n    }\n  }\n  public static Object getInstance(boolean flag) {\n    if (flag) return new LazyHolder[2];\n    return LazyHolder.INSTANCE;\n  }\n  public static void main(String[] args) {\n    getInstance(true);\n    System.out.println(\"----\");\n    getInstance(false);\n  }\n}'</span> <span class=\"token operator\">></span> Singleton.java\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Compiling...\"</span>\njavac Singleton.java\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Run with class loading order printed\"</span>\njava -verbose:class Singleton\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Reading LazyHolder\"</span>\njava -cp ~/install/asmtools.jar org.openjdk.asmtools.jdis.Main Singleton\\<span class=\"token variable\">$LazyHolder</span>.class <span class=\"token operator\">></span> Singleton\\<span class=\"token variable\">$LazyHolder</span>.jasm.1\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Mod bytecode to trigger error in the static init block of LazyHolder\"</span>\n<span class=\"token function\">awk</span> <span class=\"token string\">'NR==1,/stack 1/{sub(/stack 1/, \"stack 0\")} 1'</span> Singleton\\<span class=\"token variable\">$LazyHolder</span>.jasm.1 <span class=\"token operator\">></span> Singleton\\<span class=\"token variable\">$LazyHolder</span>.jasm\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Put back moded jasm\"</span>\njava -cp ~/install/asmtools.jar org.openjdk.asmtools.jasm.Main Singleton\\<span class=\"token variable\">$LazyHolder</span>.jasm\n\n<span class=\"token keyword\">echo</span> <span class=\"token string\">\"Run with new result\"</span>\njava -verbose:class Singleton</code></pre></div>\n<p>Refs:</p>\n<ol>\n<li>Download asmtools (<a href=\"https://wiki.openjdk.java.net/display/CodeTools/How+to+build+AsmTools\">https://wiki.openjdk.java.net/display/CodeTools/How+to+build+AsmTools</a>)</li>\n<li>This article is mainly quoted from origin tutoria (<a href=\"https://time.geekbang.org/column/article/11523\">https://time.geekbang.org/column/article/11523</a>)</li>\n</ol>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Recently I learned when Java class loader "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"load"}]},{"type":"text","value":" a class and when does it "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"initialize"}]},{"type":"text","value":" it."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Take the following as example."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can use some special jvm options to show class loading info, like "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"java -verbose:class Singleton"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"java"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-java"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Singleton"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"private"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"Singleton"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"private"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"static"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"class"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"LazyHolder"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"static"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"final"}]},{"type":"text","value":" Singleton INSTANCE "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Singleton"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"static"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n      System"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"out"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"println"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"LazyHolder.<clinit>\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"static"}]},{"type":"text","value":" Object "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"getInstance"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"boolean"}]},{"type":"text","value":" flag"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"flag"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"return"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"LazyHolder"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"2"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"return"}]},{"type":"text","value":" LazyHolder"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"INSTANCE"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"public"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"static"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"void"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"main"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"String"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":" args"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"getInstance"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","boolean"]},"children":[{"type":"text","value":"true"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    System"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"out"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"println"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"----\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"getInstance"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","boolean"]},"children":[{"type":"text","value":"false"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When execute this class, class loader will first load "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Singleton"}]},{"type":"text","value":", then load "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"LazyHolder"}]},{"type":"text","value":". But something interesting here is jvm will not "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"clinit"}]},{"type":"text","value":" the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"LazyHolder"}]},{"type":"text","value":" when constructing an empty "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Array"}]},{"type":"text","value":" of "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"LazyHolder"}]},{"type":"text","value":". It will "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"clinit"}]},{"type":"text","value":" the class when it is being really used, like "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"return LazyHolder.INSTANCE"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can try the above with script at the end."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"It will output as following order"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[0.123s][info][class,load] Singleton source: file:/Users/xueg/source/fun/javavm/03-how-class-load/"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[0.125s][info][class,load] Singleton$LazyHolder source: file:/Users/xueg/source/fun/javavm/03-how-class-load/"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Above indicates that the order the classed loaded is "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Singleton"}]},{"type":"text","value":" —> "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Singleton$LazyHolder"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":2},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"and continue output following"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"----"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This means the constructing of new LazyHolder array "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"new LazyHolder[2]"}]},{"type":"text","value":" is called. But the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"static{}"}]},{"type":"text","value":" init code of the LazyHolder is still not being called."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":3},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"and continue output following"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"java.lang.VerifyError: Operand stack overflow\nException Details:\n  Location:\n    Singleton$LazyHolder.<init>()V @0: aload_0\n  Reason:\n    Exceeded max stack size.\n  Current Frame:\n    bci: @0\n    flags: { flagThisUninit }\n    locals: { uninitializedThis }\n    stack: { }\n  Bytecode:\n    0000000: 2ab7 0007 b1\n\n        at Singleton.getInstance(Singleton.java:12)\n        at Singleton.main(Singleton.java:17)"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is because we mod the bytecode on purpose to show that even there’s an error in the init code, it doesn’t prevent jvm from loading the class"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Full scripts as follow."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","shebang","important"]},"children":[{"type":"text","value":"#!/bin/bash"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Generating Singleton.java\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'\npublic class Singleton {\n  private Singleton() {}\n  private static class LazyHolder {\n    static final Singleton INSTANCE = new Singleton();\n    static {\n      System.out.println(\"LazyHolder.<clinit>\");\n    }\n  }\n  public static Object getInstance(boolean flag) {\n    if (flag) return new LazyHolder[2];\n    return LazyHolder.INSTANCE;\n  }\n  public static void main(String[] args) {\n    getInstance(true);\n    System.out.println(\"----\");\n    getInstance(false);\n  }\n}'"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" Singleton.java\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Compiling...\""}]},{"type":"text","value":"\njavac Singleton.java\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Run with class loading order printed\""}]},{"type":"text","value":"\njava -verbose:class Singleton\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Reading LazyHolder\""}]},{"type":"text","value":"\njava -cp ~/install/asmtools.jar org.openjdk.asmtools.jdis.Main Singleton\\"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$LazyHolder"}]},{"type":"text","value":".class "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" Singleton\\"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$LazyHolder"}]},{"type":"text","value":".jasm.1\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Mod bytecode to trigger error in the static init block of LazyHolder\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"awk"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'NR==1,/stack 1/{sub(/stack 1/, \"stack 0\")} 1'"}]},{"type":"text","value":" Singleton\\"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$LazyHolder"}]},{"type":"text","value":".jasm.1 "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":">"}]},{"type":"text","value":" Singleton\\"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$LazyHolder"}]},{"type":"text","value":".jasm\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Put back moded jasm\""}]},{"type":"text","value":"\njava -cp ~/install/asmtools.jar org.openjdk.asmtools.jasm.Main Singleton\\"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$LazyHolder"}]},{"type":"text","value":".jasm\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"Run with new result\""}]},{"type":"text","value":"\njava -verbose:class Singleton"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Refs:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Download asmtools ("},{"type":"element","tagName":"a","properties":{"href":"https://wiki.openjdk.java.net/display/CodeTools/How+to+build+AsmTools"},"children":[{"type":"text","value":"https://wiki.openjdk.java.net/display/CodeTools/How+to+build+AsmTools"}]},{"type":"text","value":")"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"This article is mainly quoted from origin tutoria ("},{"type":"element","tagName":"a","properties":{"href":"https://time.geekbang.org/column/article/11523"},"children":[{"type":"text","value":"https://time.geekbang.org/column/article/11523"}]},{"type":"text","value":")"}]},{"type":"text","value":"\n"}]}],"data":{"quirksMode":false}},"excerpt":"Recently I learned when Java class loader   a class and when does it   it. Take the following as example. We can use some special jvm…","timeToRead":3,"frontmatter":{"title":"How JavaVM load class with orders","userDate":"2 January 2019","date":"2019-01-02T23:40:37.000Z","tags":["Java"],"image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAUBAwQG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAHVbCyGpzRo/8QAGRABAAMBAQAAAAAAAAAAAAAAAQADEQIT/9oACAEBAAEFAtR9khfokvU71n//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARL/2gAIAQMBAT8BZr//xAAXEQEAAwAAAAAAAAAAAAAAAAAAARJR/9oACAECAQE/AVox/8QAGhABAAIDAQAAAAAAAAAAAAAAAAFBERIxcf/aAAgBAQAGPwK4UqHjXLr/xAAcEAABBAMBAAAAAAAAAAAAAAABABEhMRBBYVH/2gAIAQEAAT8hFn1eCjad51Akc2DgFwQdDQQX/9oADAMBAAIAAwAAABCP3//EABcRAQADAAAAAAAAAAAAAAAAAAABUWH/2gAIAQMBAT8Qmmj/xAAWEQEBAQAAAAAAAAAAAAAAAAABERD/2gAIAQIBAT8QGFcH/8QAHBABAQACAwEBAAAAAAAAAAAAAREAITFBcVFh/9oACAEBAAE/EHYKd1Xh5lPQ4rVfMKL7DiOBL0iE5xAQeE00uz8wFjLYOf/Z","aspectRatio":1.4935805991440798,"src":"/static/7060f3bc9d96e91b76b63538d0b1ea48/71d24/03-class-loading-in-vm.banner.jpg","srcSet":"/static/7060f3bc9d96e91b76b63538d0b1ea48/9c79d/03-class-loading-in-vm.banner.jpg 930w,\n/static/7060f3bc9d96e91b76b63538d0b1ea48/9b0ac/03-class-loading-in-vm.banner.jpg 1860w,\n/static/7060f3bc9d96e91b76b63538d0b1ea48/71d24/03-class-loading-in-vm.banner.jpg 3141w","sizes":"(max-width: 3141px) 100vw, 3141px"}}},"author":{"id":"Gary","bio":"Gary","avatar":{"children":[{"__typename":"ImageSharp","fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABMUlEQVQ4y2MwsXf5T03MMGogGBvbOYNpUwdXOIbJwdgwNQQNhCk0snX6r2thC8Y6QGxg7QCWA/FBcrgMxepCkAZrV6//EYmpYBydkvHfMzjiv5mj2//whJT/Nm7ecEMJGgjykp6V/f+AqLj/O/Ye+L8diA8dO/m/pbv/v72n3/+tu/f9D45N/K9naYcSFESFoRXQlSCX2rh7g/kgr1u5epIWhiAMCi/3wLD/fVNn/u+fNgtMT5g+6//kmXOB/Jn/PYLCwWrINnDijDlAPBvKJ8NAZC+DIgCkGYRBbJAYSV5GjpTte/b/PwiMkLj0nP8xqVn/Dxw9AY6kwOh40iIFlmzCgUkmKjnjvx0wdu08fMFskJi1mxfxyQY9YetAEzJyQic5YaNnPeTgIDnrjZaHJGMACtTMXoVAJ6sAAAAASUVORK5CYII=","width":400,"height":400,"src":"/static/5f2c129e42248a92c87b13b4293950cf/fba88/ghost.png","srcSet":"/static/5f2c129e42248a92c87b13b4293950cf/fba88/ghost.png 1x"}}]}}}},"relatedPosts":{"totalCount":2,"edges":[{"node":{"id":"5873ca14-aa96-5ff4-9cb6-9a83218abfdb","timeToRead":2,"excerpt":"TL:DR; jvm will use   as the constant value the represen boolean  .\nBut jvm also treat any postive integer value as true, like c. Take the…","frontmatter":{"title":"How JavaVM treat boolean values"},"fields":{"slug":"/javavm/01-bool-in-vm/"}}},{"node":{"id":"6cd0914e-ac8d-575a-939b-3e3cfae19a22","timeToRead":3,"excerpt":"Recently I learned when Java class loader   a class and when does it   it. Take the following as example. We can use some special jvm…","frontmatter":{"title":"How JavaVM load class with orders"},"fields":{"slug":"/javavm/03-class-loading-in-vm/"}}}]}},"pageContext":{"slug":"/javavm/03-class-loading-in-vm/","prev":{"excerpt":"TL:DR; jvm will use   as the constant value the represen boolean  .\nBut jvm also treat any postive integer value as true, like c. Take the…","timeToRead":2,"frontmatter":{"title":"How JavaVM treat boolean values","tags":["Java"],"date":"2019-01-01T22:02:37.000Z","image":{"childImageSharp":{"fluid":{"aspectRatio":1.7725903614457832,"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABZUlEQVQoz52TW0+EMBCFobT0SqGUy7KwMTwYfTFR9///tuO06mriZjfxYVLSga/nzCnFtp3wdH5Hsx4hXQPBOWopUdc1lkeL/c1jfXboV4UmCvixhjQMJStQFFfKGI3z6wuMkpfNsiwz0HYCh90hEixuKkPTc1hk7rHqCjB92HVthvwGKq1ypR7n1XU11+vvZlkW0FojTjPmLcAPEtJW/wem0togjiPibNGOZHMyME5CmTqPQwjxVTzPPbkQXNwAGoPQRyykcFoCwVuEgcKhtaHwnLVwziJlkNwoyqBx7rbCMA5YHshypGQtg1AUlmbgkuZNY2GM5aqqKq93LfcEnPcG8aQw7RrDScMGAdOKDE7qDL1nyY36uSU3FEZSeAxoe5qdrlExTr3yn6HQqV3fY54NVprj4UjwLWJcOrTR0oEKkn4AKT9DSjfjLrAnhcPSYFg92fdwXsN3lsLysJdQTLb+fY8/AMBq7jj5D7UvAAAAAElFTkSuQmCC","sizes":"(max-width: 1177px) 100vw, 1177px","src":"/static/146580361098fc9783542d187c8bcb34/39051/01-bool-in-vm.banner.png","srcSet":"/static/146580361098fc9783542d187c8bcb34/38f0d/01-bool-in-vm.banner.png 930w,\n/static/146580361098fc9783542d187c8bcb34/39051/01-bool-in-vm.banner.png 1177w"}}},"author":{"id":"Gary","bio":"Gary","avatar":{"children":[{"fixed":{"src":"/static/5f2c129e42248a92c87b13b4293950cf/fba88/ghost.png"}}]}}},"fields":{"layout":"post","slug":"/javavm/01-bool-in-vm/"}},"next":{"excerpt":"Event Queue Javascript is a single thread languange; We can’t put thread into   mode and block thread; Event queue is the corner stone…","timeToRead":4,"frontmatter":{"title":"My two cents on Javascripts eventloop and callback","tags":["Javascript"],"date":"2019-01-27T23:16:37.000Z","image":{"childImageSharp":{"fluid":{"aspectRatio":0.7592267135325131,"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAaABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAwABAgT/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAd8SNebyzIY0PEsz/8QAGxAAAgMBAQEAAAAAAAAAAAAAAAIBAxIRIUL/2gAIAQEAAQUCsswL1mwpbzVfjjLEixCQSfR//8QAFhEAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/ASP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAeEAABAwQDAAAAAAAAAAAAAAABABAhAiAiMWGCkf/aAAgBAQAGPwLmykA7aZWIbqvW/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITEQUXGxwf/aAAgBAQABPyGl2tTb5WFWSOm9xlpCyPGEAJTaF2szNXw9z64f/9oADAMBAAIAAwAAABBrBPH/xAAZEQADAAMAAAAAAAAAAAAAAAAAAREQITH/2gAIAQMBAT8Q7rCtEP/EABgRAAIDAAAAAAAAAAAAAAAAAAAhARAR/9oACAECAQE/EITNv//EAB4QAQACAgMAAwAAAAAAAAAAAAEAESFRMUFhcbHB/9oACAEBAAE/EC4ek/Y7AW2rzKui6jwpQDOov+uoOK58lkByIi9WZa8Dvc+dP56xeskCuLDVwgAAFRq8pQgTD9hGf//Z","sizes":"(max-width: 3024px) 100vw, 3024px","src":"/static/8cc60bdd6e4661a7636902a4899733c3/8e5bd/01-js-eventloop-and-callback.jpg","srcSet":"/static/8cc60bdd6e4661a7636902a4899733c3/8bf1e/01-js-eventloop-and-callback.jpg 930w,\n/static/8cc60bdd6e4661a7636902a4899733c3/bc1ec/01-js-eventloop-and-callback.jpg 1860w,\n/static/8cc60bdd6e4661a7636902a4899733c3/8e5bd/01-js-eventloop-and-callback.jpg 3024w"}}},"author":{"id":"Gary","bio":"Gary","avatar":{"children":[{"fixed":{"src":"/static/5f2c129e42248a92c87b13b4293950cf/fba88/ghost.png"}}]}}},"fields":{"layout":"post","slug":"/javascript/01-js-eventloop-and-callback/"}},"primaryTag":"Java"}}